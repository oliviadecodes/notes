

- [1ã€åŸºæœ¬æ¦‚å¿µ](#åŸºæœ¬æ¦‚å¿µ)
- [2ã€å¸¸è§çš„5ç§IOæ¨¡å‹](#å¸¸è§çš„5ç§IOæ¨¡å‹)
- [3ã€IOå¤šè·¯å¤ç”¨select](#IOå¤šè·¯å¤ç”¨select)
  - [selectåŸç†](#selectåŸç†)
  - [selectå‡½æ•°](#selectå‡½æ•°)
  - [selectæµ‹è¯•](#selectæµ‹è¯•)
  - [selectè¿è¡Œ](#selectè¿è¡Œ)
  - [selectæ€»ç»“](#selectæ€»ç»“)
- [4ã€IOå¤šè·¯å¤ç”¨poll](#IOå¤šè·¯å¤ç”¨poll)
  - [pollåŸç†](#pollåŸç†)
  - [pollå‡½æ•°](#pollå‡½æ•°)
  - [pollæµ‹è¯•](#pollæµ‹è¯•)
  - [pollè¿è¡Œ](#pollè¿è¡Œ)
  - [pollæ€»ç»“](#pollæ€»ç»“)
- [5ã€IOå¤šè·¯å¤ç”¨epoll](#IOå¤šè·¯å¤ç”¨epoll)
  - [epollåŸç†](#epollåŸç†)
  - [epollå‡½æ•°](#epollå‡½æ•°)
  - [epollæ¨¡å¼](#epollæ¨¡å¼)
  - [epollæµ‹è¯•](#epollæµ‹è¯•)
  - [epollè¿è¡Œ](#epollè¿è¡Œ)
  - [epollæ€»ç»“](#epollæ€»ç»“)
- [6ã€selectã€pollã€epollåŒºåˆ«](#selectã€pollã€epollåŒºåˆ«)
  - [1ã€æœ€å¤§è¿æ¥æ•°](#æœ€å¤§è¿æ¥æ•°)
  - [2ã€IOæ•ˆç‡é—®é¢˜](#IOæ•ˆç‡é—®é¢˜)
  - [3ã€æ¶ˆæ¯ä¼ é€’æ–¹å¼](#æ¶ˆæ¯ä¼ é€’æ–¹å¼)

# 1ã€åŸºæœ¬æ¦‚å¿µ

IOå¤šè·¯å¤ç”¨æ˜¯æŒ‡å†…æ ¸ä¸€æ—¦å‘ç°è¿›ç¨‹æŒ‡å®šçš„ä¸€ä¸ªæˆ–è€…å¤šä¸ªIOæ¡ä»¶å‡†å¤‡è¯»å–ï¼Œå®ƒå°±é€šçŸ¥è¯¥è¿›ç¨‹ã€‚IOå¤šè·¯å¤ç”¨é€‚ç”¨å¦‚ä¸‹åœºåˆï¼š

> ï¼ˆ1ï¼‰å½“å®¢æˆ·å¤„ç†å¤šä¸ªæè¿°å­—æ—¶ï¼ˆä¸€èˆ¬æ˜¯äº¤äº’å¼è¾“å…¥å’Œç½‘ç»œå¥—æ¥å£ï¼‰ï¼Œå¿…é¡»ä½¿ç”¨I/Oå¤ç”¨ã€‚
>
> ï¼ˆ2ï¼‰å½“ä¸€ä¸ªå®¢æˆ·åŒæ—¶å¤„ç†å¤šä¸ªå¥—æ¥å£æ—¶ï¼Œè€Œè¿™ç§æƒ…å†µæ˜¯å¯èƒ½çš„ï¼Œä½†å¾ˆå°‘å‡ºç°ã€‚
>
> ï¼ˆ3ï¼‰å¦‚æœä¸€ä¸ªTCPæœåŠ¡å™¨æ—¢è¦å¤„ç†ç›‘å¬å¥—æ¥å£ï¼Œåˆè¦å¤„ç†å·²è¿æ¥å¥—æ¥å£ï¼Œä¸€èˆ¬ä¹Ÿè¦ç”¨åˆ°I/Oå¤ç”¨ã€‚
>
> ï¼ˆ4ï¼‰å¦‚æœä¸€ä¸ªæœåŠ¡å™¨å³è¦å¤„ç†TCPï¼Œåˆè¦å¤„ç†UDPï¼Œä¸€èˆ¬è¦ä½¿ç”¨I/Oå¤ç”¨ã€‚
>
> ï¼ˆ5ï¼‰å¦‚æœä¸€ä¸ªæœåŠ¡å™¨è¦å¤„ç†å¤šä¸ªæœåŠ¡æˆ–å¤šä¸ªåè®®ï¼Œä¸€èˆ¬è¦ä½¿ç”¨I/Oå¤ç”¨ã€‚

ä¸å¤šè¿›ç¨‹å’Œå¤šçº¿ç¨‹æŠ€æœ¯ç›¸æ¯”ï¼ŒI/Oå¤šè·¯å¤ç”¨æŠ€æœ¯çš„æœ€å¤§ä¼˜åŠ¿æ˜¯ç³»ç»Ÿå¼€é”€å°ï¼Œç³»ç»Ÿä¸å¿…åˆ›å»ºè¿›ç¨‹/çº¿ç¨‹ï¼Œä¹Ÿä¸å¿…ç»´æŠ¤è¿™äº›è¿›ç¨‹/çº¿ç¨‹ï¼Œä»è€Œå¤§å¤§å‡å°äº†ç³»ç»Ÿçš„å¼€é”€ã€‚

æ€»è€Œè¨€ä¹‹ï¼ŒIOå¤šè·¯å¤ç”¨å°±æ˜¯ï¼š**ä¸€ä¸ªçº¿ç¨‹ï¼Œé€šè¿‡è®°å½•I/Oæµçš„çŠ¶æ€æ¥åŒæ—¶ç®¡ç†å¤šä¸ªI/Oï¼Œå¯ä»¥æé«˜æœåŠ¡å™¨çš„ååèƒ½åŠ›**ã€‚

# 2ã€å¸¸è§çš„5ç§IOæ¨¡å‹

```c
1.é˜»å¡I/Oæ¨¡å‹
éš”å£è€ç‹å»ç«è½¦ç«™ä¹°ç¥¨ï¼Œæ’é˜Ÿä¸‰å¤©ä¹°åˆ°ä¸€å¼ é€€ç¥¨ã€‚
è€—è´¹ï¼šåœ¨è½¦ç«™åƒå–æ‹‰æ’’ç¡ 3 å¤©ï¼Œå…¶å®ƒäº‹ä¸€ä»¶æ²¡å¹²ã€‚
```

```c
2.éé˜»å¡I/Oæ¨¡å‹
éš”å£è€ç‹å»ç«è½¦ç«™ä¹°ç¥¨ï¼Œéš” 12 å°æ—¶å»ç«è½¦ç«™é—®æœ‰æ²¡æœ‰é€€ç¥¨ï¼Œä¸‰å¤©åä¹°åˆ°ä¸€å¼ ç¥¨ã€‚
è€—è´¹ï¼šå¾€è¿”è½¦ç«™ 6 æ¬¡ï¼Œè·¯ä¸Š 6 å°æ—¶ï¼Œå…¶å®ƒæ—¶é—´åšäº†å¥½å¤šäº‹ã€‚
```

```c
3.I/Oå¤ç”¨æ¨¡å‹
â‘  select/poll
éš”å£è€ç‹å»ç«è½¦ç«™ä¹°ç¥¨ï¼Œå§”æ‰˜é»„ç‰›ï¼Œç„¶åæ¯éš” 6 å°æ—¶ç”µè¯é»„ç‰›è¯¢é—®ï¼Œé»„ç‰›ä¸‰å¤©å†…ä¹°åˆ°ç¥¨ï¼Œç„¶åéš”å£è€ç‹å»ç«è½¦ç«™äº¤é’±é¢†ç¥¨ã€‚
è€—è´¹ï¼šå¾€è¿”è½¦ç«™ 2 æ¬¡ï¼Œè·¯ä¸Š 2 å°æ—¶ï¼Œé»„ç‰›æ‰‹ç»­è´¹ 100 å…ƒï¼Œæ‰“ç”µè¯ 17 æ¬¡ã€‚
â‘¡ epoll
éš”å£è€ç‹å»ç«è½¦ç«™ä¹°ç¥¨ï¼Œå§”æ‰˜é»„ç‰›ï¼Œé»„ç‰›ä¹°åˆ°åå³é€šçŸ¥éš”å£è€ç‹å»é¢†ï¼Œç„¶åéš”å£è€ç‹å»ç«è½¦ç«™äº¤é’±é¢†ç¥¨ã€‚
è€—è´¹ï¼šå¾€è¿”è½¦ç«™ 2 æ¬¡ï¼Œè·¯ä¸Š 2 å°æ—¶ï¼Œé»„ç‰›æ‰‹ç»­è´¹ 100 å…ƒï¼Œæ— éœ€æ‰“ç”µè¯
```

```c
4.ä¿¡å·é©±åŠ¨I/Oæ¨¡å‹
éš”å£è€ç‹å»ç«è½¦ç«™ä¹°ç¥¨ï¼Œç»™å”®ç¥¨å‘˜ç•™ä¸‹ç”µè¯ï¼Œæœ‰ç¥¨åï¼Œå”®ç¥¨å‘˜ç”µè¯é€šçŸ¥éš”å£è€ç‹ï¼Œç„¶åéš”å£è€ç‹å»ç«è½¦ç«™äº¤é’±é¢†ç¥¨ã€‚
è€—è´¹ï¼šå¾€è¿”è½¦ç«™ 2 æ¬¡ï¼Œè·¯ä¸Š 2 å°æ—¶ï¼Œå…é»„ç‰›è´¹ 100 å…ƒï¼Œæ— éœ€æ‰“ç”µè¯
```

```c
5.å¼‚æ­¥I/Oæ¨¡å‹
éš”å£è€ç‹å»ç«è½¦ç«™ä¹°ç¥¨ï¼Œç»™å”®ç¥¨å‘˜ç•™ä¸‹ç”µè¯ï¼Œæœ‰ç¥¨åï¼Œå”®ç¥¨å‘˜ç”µè¯é€šçŸ¥éš”å£è€ç‹å¹¶å¿«é€’é€ç¥¨ä¸Šé—¨ã€‚
è€—è´¹ï¼šå¾€è¿”è½¦ç«™ 1 æ¬¡ï¼Œè·¯ä¸Š 1 å°æ—¶ï¼Œå…é»„ç‰›è´¹ 100 å…ƒï¼Œæ— éœ€æ‰“ç”µè¯
```

# 3ã€IOå¤šè·¯å¤ç”¨select

## selectåŸç†

è¯¥å‡½æ•°å‡†è®¸è¿›ç¨‹æŒ‡ç¤ºå†…æ ¸ç­‰å¾…å¤šä¸ªäº‹ä»¶ä¸­çš„ä»»ä½•ä¸€ä¸ªå‘é€ï¼Œå¹¶åªåœ¨æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªäº‹ä»¶å‘ç”Ÿæˆ–ç»å†ä¸€æ®µæŒ‡å®šçš„æ—¶é—´åæ‰å”¤é†’ã€‚

## selectå‡½æ•°

```c
#include <sys/select.h>
#include <sys/time.h>

int select(int maxfdp1, fd_set *readset, fd_set *writeset, fd_set *exceptset, const struct timeval *timeout)
```

> å‡½æ•°å‚æ•°ä»‹ç»å¦‚ä¸‹ï¼š
>
> ï¼ˆ1ï¼‰ç¬¬ä¸€ä¸ªå‚æ•°maxfdp1æŒ‡å®šå¾…æµ‹è¯•çš„æè¿°å­—ä¸ªæ•°ï¼Œå®ƒçš„å€¼æ˜¯å¾…æµ‹è¯•çš„æœ€å¤§æè¿°å­—åŠ 1ï¼ˆå› æ­¤æŠŠè¯¥å‚æ•°å‘½åä¸ºmaxfdp1ï¼‰ï¼Œæè¿°å­—0ã€1ã€2...maxfdp1-1å‡å°†è¢«æµ‹è¯•ã€‚å› ä¸ºæ–‡ä»¶æè¿°ç¬¦æ˜¯ä»0å¼€å§‹çš„ã€‚
>
> ï¼ˆ2ï¼‰ä¸­é—´çš„ä¸‰ä¸ªå‚æ•°readsetã€writeset å’Œ exceptset æŒ‡å®šæˆ‘ä»¬è¦è®©å†…æ ¸æµ‹è¯•è¯»ã€å†™å’Œå¼‚å¸¸æ¡ä»¶çš„æè¿°å­—ã€‚å¦‚æœå¯¹æŸä¸€ä¸ªçš„æ¡ä»¶ä¸æ„Ÿå…´è¶£ï¼Œå°±å¯ä»¥æŠŠå®ƒè®¾ä¸ºç©ºæŒ‡é’ˆã€‚struct fd_setå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªé›†åˆï¼Œè¿™ä¸ªé›†åˆä¸­å­˜æ”¾çš„æ˜¯æ–‡ä»¶æè¿°ç¬¦ï¼Œå¯é€šè¿‡ä»¥ä¸‹å››ä¸ªå®è¿›è¡Œè®¾ç½®ï¼š
>
> ```c
> void FD_ZERO(fd_set *fdset);           //æ¸…ç©ºé›†åˆ
> 
> void FD_SET(int fd, fd_set *fdset);    //å°†ä¸€ä¸ªç»™å®šçš„æ–‡ä»¶æè¿°ç¬¦åŠ å…¥é›†åˆä¹‹ä¸­
> 
> void FD_CLR(int fd, fd_set *fdset);    //å°†ä¸€ä¸ªç»™å®šçš„æ–‡ä»¶æè¿°ç¬¦ä»é›†åˆä¸­åˆ é™¤
> 
> int FD_ISSET(int fd, fd_set *fdset);   // æ£€æŸ¥é›†åˆä¸­æŒ‡å®šçš„æ–‡ä»¶æè¿°ç¬¦æ˜¯å¦å¯ä»¥è¯»å†™ 
> ```
>
> ï¼ˆ3ï¼‰timeoutå‘ŠçŸ¥å†…æ ¸ç­‰å¾…æ‰€æŒ‡å®šæè¿°å­—ä¸­çš„ä»»ä½•ä¸€ä¸ªå°±ç»ªå¯èŠ±å¤šå°‘æ—¶é—´ã€‚å…¶timevalç»“æ„ç”¨äºæŒ‡å®šè¿™æ®µæ—¶é—´çš„ç§’æ•°å’Œå¾®ç§’æ•°ã€‚
>
> ```c
>  struct timeval {
> 
> 	long tv_sec;   //seconds
> 
> 	long tv_usec;  //microseconds
> 
> };
> ```
>
> è¿™ä¸ªå‚æ•°æœ‰ä¸‰ç§å¯èƒ½ï¼š
>
> ï¼ˆ1ï¼‰æ°¸è¿œç­‰å¾…ä¸‹å»ï¼šä»…åœ¨æœ‰ä¸€ä¸ªæè¿°å­—å‡†å¤‡å¥½I/Oæ—¶æ‰è¿”å›ã€‚ä¸ºæ­¤ï¼ŒæŠŠè¯¥å‚æ•°è®¾ç½®ä¸ºç©ºæŒ‡é’ˆNULLã€‚
>
> ï¼ˆ2ï¼‰ç­‰å¾…ä¸€æ®µå›ºå®šæ—¶é—´ï¼šåœ¨æœ‰ä¸€ä¸ªæè¿°å­—å‡†å¤‡å¥½I/Oæ—¶è¿”å›ï¼Œä½†æ˜¯ä¸è¶…è¿‡ç”±è¯¥å‚æ•°æ‰€æŒ‡å‘çš„timevalç»“æ„ä¸­æŒ‡å®šçš„ç§’æ•°å’Œå¾®ç§’æ•°ã€‚
>
> ï¼ˆ3ï¼‰æ ¹æœ¬ä¸ç­‰å¾…ï¼šæ£€æŸ¥æè¿°å­—åç«‹å³è¿”å›ï¼Œè¿™ç§°ä¸ºè½®è¯¢ã€‚ä¸ºæ­¤ï¼Œè¯¥å‚æ•°å¿…é¡»æŒ‡å‘ä¸€ä¸ªtimevalç»“æ„ï¼Œè€Œä¸”å…¶ä¸­çš„å®šæ—¶å™¨å€¼å¿…é¡»ä¸º0ã€‚

> ![selectåŸç†å›¾](./pic/selectåŸç†å›¾.png)

## selectæµ‹è¯•

æœåŠ¡å™¨ç«¯

```c
/*************************************************************************
	> File Name: select_server.c
	> Author: zhengdongqi
	> Mail: 
	> Created Time: ä¸€  4/ 8 16:04:11 2019
 ************************************************************************/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <errno.h>
#include <unistd.h>
#include <assert.h>
#include <sys/select.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <arpa/inet.h>

#ifdef _DEBUG
#define DBG(fmt, args...) printf(fmt, ##args)
#else
#define DBG(fmt, args...)
#endif

#define IPADDR "192.168.2.165"
#define PORT 8888
#define MAXSIZE 1024
#define LISTENQ 5
#define SIZE 10

/*å®šä¹‰ä¸€ä¸ªç»“æ„ä½“å­˜æ”¾æ•°æ®ä¿¡æ¯*/
typedef struct date_t {
    int cli_cnt; /*å®¢æˆ·æ•°é‡*/
    int cli_fds[SIZE]; /*å®¢æˆ·å¥—æ¥å­—*/
    fd_set allfds; /*å¥æŸ„é›†åˆ*/
    int maxfd; /*å¥æŸ„æœ€å¤§å€¼*/
} date_t;
date_t *cli_d = NULL;

/*å‡½æ•°å£°æ˜*/
/*åˆ›å»ºä¸€ä¸ªsocket ç±»å‹TCP*/
int socket_create_tcp(int port);
/*åˆ›å»ºä¸€ä¸ªæ¥æ”¶å‡½æ•°*/
int socket_accept_tcp(int sockfd);
/*å¤„ç†æ”¶åˆ°çš„æ¶ˆæ¯*/
int handle_recv_msg(int fd, char *buf);s
 /*æ¥æ”¶æ¶ˆæ¯*/
void socket_recv_msg(fd_set *rset);
/*selectå¤„ç†å‡½æ•°*/
void handle_select_proc(int sockfd);
/*åˆ›å»ºä¸€ä¸ªsocket ç±»å‹TCP*/
/*é”€æ¯æ•°æ®*/
void date_destroy();
/*åˆå§‹åŒ–*/
int socket_init();

int main() {
    DBG("\033[33må¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ğŸ’\033[0m\n");
    fflush(stdout);
    int fd;
    /*åˆå§‹åŒ–æœåŠ¡ç«¯*/
    if (socket_init() < 0) {
        return -1;
    }
    /*åˆ›å»ºæœåŠ¡,å¼€å§‹ç›‘å¬å®¢æˆ·ç«¯è¯·æ±‚*/
    fd = socket_create_tcp(PORT);
    if (fd < 0) {
        DBG("\033[31må¥—æ¥å­—åˆ›å»ºå¤±è´¥\033[0m\n");
        return -1;
    }
    /*å¼€å§‹æ¥æ”¶å¹¶å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚*/
    handle_select_proc(fd);
    date_destroy();
    return 0;
}
/*åˆ›å»ºä¸€ä¸ªsocket ç±»å‹TCP*/
int socket_create_tcp(int port) {
    int socket_fd;
    struct sockaddr_in socket_addr;
    //åˆ›å»ºå¥—æ¥å­—
    socket_fd = socket(AF_INET, SOCK_STREAM, 0);
    if (socket_fd < 0) {
        DBG("socket_create_tcp->\033[31måˆ›å»ºå¥—æ¥å­—å¤±è´¥: %s\033[0m\n", strerror(errno));
        close(socket_fd);
        return -1;
    }
    //è®¾ç½®æœåŠ¡å™¨
    memset(&socket_addr, 0, sizeof(socket_addr));//æ•°æ®åˆå§‹åŒ–æ¸…é›¶
    socket_addr.sin_family = AF_INET;//è®¾ç½®åè®®æ—
    socket_addr.sin_port = htons(port);//ç«¯å£
    socket_addr.sin_addr.s_addr = htonl(INADDR_ANY);//IPåœ°å€
    //ç«¯å£é‡ç”¨
    int reuse = 1;
    if (setsockopt(socket_fd, SOL_SOCKET, SO_REUSEADDR, &reuse, sizeof(reuse)) == -1) {
        DBG("socket_create_tcp->\033[31mè®¾ç½®ç«¯å£é‡ç”¨å¤±è´¥: %s\033[0m\n", strerror(errno));
        close(socket_fd);
        return -1;
    }
    //ç»‘å®šè¿æ¥
    if (bind(socket_fd, (struct sockaddr*)&socket_addr, sizeof(struct sockaddr)) < 0) {
        DBG("socket_create_tcp->\033[31mç»‘å®šå¤±è´¥: %s\033[0m\n", strerror(errno));
        close(socket_fd);
        return -1;
    }
    //è®¾ç½®ç›‘å¬
    if (listen(socket_fd, 20) < 0) {
        DBG("socket_create_tcp->\033[31mç›‘å¬å¤±è´¥: %s\033[0m\n", strerror(errno));
        close(socket_fd);
        return -1;
    }
    return socket_fd;
}
/*åˆ›å»ºä¸€ä¸ªæ¥æ”¶å‡½æ•°*/
int socket_accept_tcp(int sockfd) {
    int afd = -1;
    struct sockaddr_in accept_addr;
    int len = sizeof(accept_addr);

    afd = accept(sockfd, (struct sockaddr *)&accept_addr, (socklen_t *)&len);

    if (afd == -1) {
        DBG ("socket_accept_tcp->\033[31mæ¥æ”¶å¤±è´¥: %s\033[0m\n", strerror(errno));
        return -1;
    }

    //å°†æ–°çš„è¿æ¥æè¿°ç¬¦æ·»åŠ åˆ°æ•°ç»„ä¸­
    int i = 0;
    for (i = 0; i < SIZE; i++) {
        if (cli_d->cli_fds[i] < 0) {
            cli_d->cli_fds[i] = afd;
            cli_d->cli_cnt++;
            break;
        }
    }

    if (i == SIZE) {
        DBG("socket_accept_tcp->\033[31må¤ªå¤šå®¢æˆ·äº† å¥½ç´¯å•ŠğŸ˜¢\033[0m\n");
        fflush(stdout);
        return -1;
    }
    return 0;
}
/*å¤„ç†æ”¶åˆ°çš„æ¶ˆæ¯*/
int handle_recv_msg(int fd, char *buf) {
    assert(buf);
    printf("handle_recv_msg->\033[32mrecv buf is :%s\033[0m\n", buf);
    write(fd, buf, strlen(buf) +1);
    return 0;
}
/*æ¥æ”¶æ¶ˆæ¯*/
void socket_recv_msg(fd_set *rset) {
    int i = 0, n = 0;
    int fd;
    char buf[MAXSIZE] = {0};
    for (i = 0; i <= cli_d->cli_cnt; i++) {
        fd = cli_d->cli_fds[i];
        if (fd < 0) {
            continue;
        }
        /*åˆ¤æ–­å®¢æˆ·ç«¯å¥—æ¥å­—æ˜¯å¦æœ‰æ•°æ®*/
        if (FD_ISSET(fd, rset)) {
            //æ¥æ”¶å®¢æˆ·ç«¯å‘é€çš„ä¿¡æ¯
            n = read(fd, buf, MAXSIZE);
            if (n <= 0) {
                /*n==0è¡¨ç¤ºè¯»å–å®Œæˆï¼Œå®¢æˆ·éƒ½å…³é—­å¥—æ¥å­—*/
                FD_CLR(fd, &cli_d->allfds);
                close(fd);
                cli_d->cli_fds[i] = -1;
                continue;
            }
            handle_recv_msg(fd, buf);
        }
    }
}
/*selectå¤„ç†å‡½æ•°*/
void handle_select_proc(int sockfd) {
    int fd = -1;
    int nfd = 0;
    fd_set *rset = &cli_d->allfds;
    struct timeval tv;
    int i = 0;

    while (1) {
        /*æ¯æ¬¡è°ƒç”¨selectå‰éƒ½è¦é‡æ–°è®¾ç½®æ–‡ä»¶æè¿°ç¬¦å’Œæ—¶é—´ï¼Œå› ä¸ºäº‹ä»¶å‘ç”Ÿåï¼Œæ–‡ä»¶æè¿°ç¬¦å’Œæ—¶é—´éƒ½è¢«å†…æ ¸ä¿®æ”¹å•¦*/
        FD_ZERO(rset);
        /*æ·»åŠ ç›‘å¬å¥—æ¥å­—*/
        FD_SET(sockfd, rset);
        cli_d->maxfd = sockfd;

        tv.tv_sec = 30;
        tv.tv_usec = 0;

        /*æ·»åŠ å®¢æˆ·ç«¯å¥—æ¥å­—*/
        for (i = 0; i < cli_d->cli_cnt; i++) {
            fd = cli_d->cli_fds[i];
            /*å»é™¤æ— æ•ˆçš„å®¢æˆ·ç«¯å¥æŸ„*/
            if (fd != -1) {
                FD_SET(fd, rset);
            }
            cli_d->maxfd = (fd > cli_d->maxfd ? fd : cli_d->maxfd);
        }

        /*å¼€å§‹è½®è¯¢æ¥æ”¶å¤„ç†æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å¥—æ¥å­—*/
        nfd = select(cli_d->maxfd + 1, rset, NULL, NULL, &tv);
        if (nfd == -1) {
            DBG("handle_socket_select->\033[31mselectå¤±è´¥: %s\033[0m\n", strerror(errno));
            return ;
        }
        if (nfd == 0) {
            DBG("handle_socket_select->\033[31mselectè¶…æ—¶: %s\033[0m\n", strerror(errno));
            continue;
        }
        if (FD_ISSET(sockfd, rset)) {
            /*ç›‘å¬å®¢æˆ·ç«¯è¯·æ±‚*/
            socket_accept_tcp(sockfd);
        } else {
            /*æ¥å—å¤„ç†å®¢æˆ·ç«¯æ¶ˆæ¯*/
            socket_recv_msg(rset);
        }
    }
	return ;
}
/*é”€æ¯æ•°æ®*/
void date_destroy() {
    if (cli_d) {
        free(cli_d);
        cli_d = NULL;
    }
    return ;
}
/*åˆå§‹åŒ–*/
int socket_init() {
    cli_d = (date_t *)malloc(sizeof(date_t));
    if (cli_d == NULL) {
        return -1;
    }

    memset(cli_d, 0, sizeof(date_t));

    int i = 0;
    for (; i < SIZE; i++) {
        cli_d->cli_fds[i] = -1;
    }
    return 0;
}
```

å®¢æˆ·ç«¯

```c
/*************************************************************************
	> File Name: select_client.c
	> Author: zhengdongqi
	> Mail: 
	> Created Time: ä¸€  4/ 8 17:36:23 2019
 ************************************************************************/

#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <sys/select.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <arpa/inet.h>
#include <time.h>
#include <unistd.h>
#include <errno.h>

#ifdef _DEBUG
#define DBG(fmt, args...) printf(fmt, ##args)
#else
#define DBG(fmt, args...)
#endif

#define MAXLINE 1024
#define IPADDR "192.168.2.165"
#define PORT 8888
/*å¤„ç†æ¥æ”¶ä¿¡æ¯*/
void handle_recv_msg(int sockfd, char *buf)  {
    DBG("handle_recv_msg->\033[33mæœåŠ¡å™¨å‘æ¥æ¶ˆæ¯: %s\033[0m\n", buf);
    sleep(5);
    write(sockfd, buf, strlen(buf) +1);
}

 
/*å¤„ç†å¥—æ¥å­—è¿æ¥*/
void handle_socket_connect(int fd) {
    char sendline[MAXLINE],recvline[MAXLINE];
    int maxfd = 0;
    fd_set rset;
    int n;
    struct timeval tv;
    int nfd = 0;

    while (1) {

        FD_ZERO(&rset);
        FD_SET(fd, &rset);
        maxfd = fd;

        tv.tv_sec = 5;
        tv.tv_usec = 0;

        nfd = select(maxfd + 1, &rset, NULL, NULL, &tv);

        if (nfd == -1) {
            return ;
        }

        if (nfd == 0) {
            DBG("handle_socket_connect->\033[31mselectè¶…æ—¶\033[0m\n");
            continue;
        }

        if (FD_ISSET(fd, &rset)) {
            n = read(fd, recvline, MAXLINE);
            if (n <= 0) {
                DBG("handle_socket_connect->\033[31mæœåŠ¡å™¨å·²å…³é—­\033[0m\n");
                close(fd);
                FD_CLR(fd, &rset);
            return;
            }
        handle_recv_msg(fd, recvline);
        }
    }
}

int main() {
    int socket_fd;
    struct sockaddr_in socket_addr;

    socket_fd = socket(AF_INET, SOCK_STREAM, 0);

    memset(&socket_addr, 0, sizeof(socket_addr));
    socket_addr.sin_family = AF_INET;
    socket_addr.sin_port = htons(PORT);
    socket_addr.sin_addr.s_addr = inet_addr(IPADDR);

    int nfd = 0;
    nfd = connect(socket_fd,(struct sockaddr*)&socket_addr, sizeof(socket_addr));
    if (nfd < 0) {
        DBG("\033[31mè¿æ¥å¤±è´¥: %s\033[0m\n", strerror(errno));
        return -1;
    }

    DBG("\033[33måˆæ¬¡è§é¢è¯·å¤šå…³ç…§ğŸ˜„\033[0m\n");
    fflush(stdout);
    write(socket_fd, "hello server", 32);

    handle_socket_connect(socket_fd);

    return 0;
}
```

## selectè¿è¡Œ

![select_server](./pic/select_server.png)

![select_client](./pic/select_client.png)

## selectæ€»ç»“

selectç›®å‰å‡ ä¹åœ¨æ‰€æœ‰çš„å¹³å°ä¸Šæ”¯æŒï¼Œ`å…¶è‰¯å¥½è·¨å¹³å°æ”¯æŒä¹Ÿæ˜¯å®ƒçš„ä¸€ä¸ªä¼˜ç‚¹`ã€‚`selectçš„ä¸€ä¸ªç¼ºç‚¹åœ¨äºå•ä¸ªè¿›ç¨‹èƒ½å¤Ÿç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦çš„æ•°é‡å­˜åœ¨æœ€å¤§é™åˆ¶`ï¼Œåœ¨Linuxä¸Šä¸€èˆ¬ä¸º1024ï¼Œ`å¯ä»¥é€šè¿‡ä¿®æ”¹å®å®šä¹‰ç”šè‡³é‡æ–°ç¼–è¯‘å†…æ ¸çš„æ–¹å¼æå‡è¿™ä¸€é™åˆ¶`ï¼Œä½†æ˜¯è¿™æ ·ä¹Ÿä¼šé€ æˆæ•ˆç‡çš„é™ä½ã€‚

`selectæœ¬è´¨ä¸Šæ˜¯é€šè¿‡è®¾ç½®æˆ–è€…æ£€æŸ¥å­˜æ”¾fdæ ‡å¿—ä½çš„æ•°æ®ç»“æ„æ¥è¿›è¡Œä¸‹ä¸€æ­¥å¤„ç†`ã€‚è¿™æ ·æ‰€å¸¦æ¥çš„ç¼ºç‚¹æ˜¯ï¼š

1ã€selectæœ€å¤§çš„ç¼ºé™·å°±æ˜¯å•ä¸ªè¿›ç¨‹æ‰€æ‰“å¼€çš„FDæ˜¯æœ‰ä¸€å®šé™åˆ¶çš„ï¼Œå®ƒç”±FD_SETSIZEè®¾ç½®ï¼Œé»˜è®¤å€¼æ˜¯1024ã€‚

ã€€ã€€ä¸€èˆ¬æ¥è¯´è¿™ä¸ªæ•°ç›®å’Œç³»ç»Ÿå†…å­˜å…³ç³»å¾ˆå¤§ï¼Œ`å…·ä½“æ•°ç›®å¯ä»¥cat /proc/sys/fs/file-maxå¯Ÿçœ‹`ã€‚32ä½æœºé»˜è®¤æ˜¯1024ä¸ªã€‚64ä½æœºé»˜è®¤æ˜¯2048.

2ã€å¯¹socketè¿›è¡Œæ‰«ææ—¶æ˜¯çº¿æ€§æ‰«æï¼Œå³é‡‡ç”¨è½®è¯¢çš„æ–¹æ³•ï¼Œæ•ˆç‡è¾ƒä½ã€‚

ã€€ã€€å½“å¥—æ¥å­—æ¯”è¾ƒå¤šçš„æ—¶å€™ï¼Œæ¯æ¬¡select()éƒ½è¦é€šè¿‡éå†FD_SETSIZEä¸ªSocketæ¥å®Œæˆè°ƒåº¦ï¼Œä¸ç®¡å“ªä¸ªSocketæ˜¯æ´»è·ƒçš„ï¼Œéƒ½éå†ä¸€éã€‚è¿™ä¼šæµªè´¹å¾ˆå¤šCPUæ—¶é—´ã€‚`å¦‚æœèƒ½ç»™å¥—æ¥å­—æ³¨å†ŒæŸä¸ªå›è°ƒå‡½æ•°ï¼Œå½“ä»–ä»¬æ´»è·ƒæ—¶ï¼Œè‡ªåŠ¨å®Œæˆç›¸å…³æ“ä½œï¼Œé‚£å°±é¿å…äº†è½®è¯¢`ï¼Œè¿™æ­£æ˜¯epollä¸kqueueåšçš„ã€‚

3ã€éœ€è¦ç»´æŠ¤ä¸€ä¸ªç”¨æ¥å­˜æ”¾å¤§é‡fdçš„æ•°æ®ç»“æ„ï¼Œè¿™æ ·ä¼šä½¿å¾—ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´åœ¨ä¼ é€’è¯¥ç»“æ„æ—¶å¤åˆ¶å¼€é”€å¤§ã€‚

# 4ã€IOå¤šè·¯å¤ç”¨poll

## pollåŸç†

pollçš„æœºåˆ¶ä¸selectç±»ä¼¼ï¼Œä¸selectåœ¨æœ¬è´¨ä¸Šæ²¡æœ‰å¤šå¤§å·®åˆ«ï¼Œç®¡ç†å¤šä¸ªæè¿°ç¬¦ä¹Ÿæ˜¯è¿›è¡Œè½®è¯¢ï¼Œæ ¹æ®æè¿°ç¬¦çš„çŠ¶æ€è¿›è¡Œå¤„ç†ï¼Œä½†æ˜¯pollæ²¡æœ‰æœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ•°é‡çš„é™åˆ¶ã€‚pollå’ŒselectåŒæ ·å­˜åœ¨ä¸€ä¸ªç¼ºç‚¹å°±æ˜¯ï¼ŒåŒ…å«å¤§é‡æ–‡ä»¶æè¿°ç¬¦çš„æ•°ç»„è¢«æ•´ä½“å¤åˆ¶äºç”¨æˆ·æ€å’Œå†…æ ¸çš„åœ°å€ç©ºé—´ä¹‹é—´ï¼Œè€Œä¸è®ºè¿™äº›æ–‡ä»¶æè¿°ç¬¦æ˜¯å¦å°±ç»ªï¼Œå®ƒçš„å¼€é”€éšç€æ–‡ä»¶æè¿°ç¬¦æ•°é‡çš„å¢åŠ è€Œçº¿æ€§å¢å¤§ã€‚

## pollå‡½æ•°

å‡½æ•°æ ¼å¼å¦‚ä¸‹æ‰€ç¤ºï¼š

```c
#include <poll.h>
int poll(struct pollfd *fds, unsigned int nfds, int timeout);
```

pollfdç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š

```c
struct pollfd {
	int fd;         	/* æ–‡ä»¶æè¿°ç¬¦ */
	short events;       /* ç­‰å¾…çš„äº‹ä»¶ */
	short revents;      /* å®é™…å‘ç”Ÿäº†çš„äº‹ä»¶ */
}; 
```

æ¯ä¸€ä¸ªpollfdç»“æ„ä½“æŒ‡å®šäº†ä¸€ä¸ªè¢«ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¯ä»¥ä¼ é€’å¤šä¸ªç»“æ„ä½“ï¼ŒæŒ‡ç¤ºpoll()ç›‘è§†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚æ¯ä¸ªç»“æ„ä½“çš„eventsåŸŸæ˜¯ç›‘è§†è¯¥æ–‡ä»¶æè¿°ç¬¦çš„äº‹ä»¶æ©ç ï¼Œç”±ç”¨æˆ·æ¥è®¾ç½®è¿™ä¸ªåŸŸã€‚reventsåŸŸæ˜¯æ–‡ä»¶æè¿°ç¬¦çš„æ“ä½œç»“æœäº‹ä»¶æ©ç ï¼Œå†…æ ¸åœ¨è°ƒç”¨è¿”å›æ—¶è®¾ç½®è¿™ä¸ªåŸŸã€‚eventsåŸŸä¸­è¯·æ±‚çš„ä»»ä½•äº‹ä»¶éƒ½å¯èƒ½åœ¨reventsåŸŸä¸­è¿”å›ã€‚åˆæ³•çš„äº‹ä»¶å¦‚ä¸‹ï¼š

```c
POLLIN ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€//æœ‰æ•°æ®å¯è¯»ã€‚
POLLRDNORM ã€€ã€€ã€€ã€€   //æœ‰æ™®é€šæ•°æ®å¯è¯»ã€‚
POLLRDBANDã€€ã€€ã€€ã€€ã€€  //æœ‰ä¼˜å…ˆæ•°æ®å¯è¯»ã€‚
POLLPRIã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€//æœ‰ç´§è¿«æ•°æ®å¯è¯»ã€‚
POLLOUTã€€ã€€ã€€ã€€ã€€ã€€   //å†™æ•°æ®ä¸ä¼šå¯¼è‡´é˜»å¡ã€‚
POLLWRNORMã€€ã€€ã€€ã€€ã€€  //å†™æ™®é€šæ•°æ®ä¸ä¼šå¯¼è‡´é˜»å¡ã€‚
POLLWRBANDã€€ã€€ã€€ã€€ã€€  //å†™ä¼˜å…ˆæ•°æ®ä¸ä¼šå¯¼è‡´é˜»å¡ã€‚
POLLMSGSIGPOLL ã€€ã€€ã€€//æ¶ˆæ¯å¯ç”¨ã€‚

/*æ­¤å¤–ï¼ŒreventsåŸŸä¸­è¿˜å¯èƒ½è¿”å›ä¸‹åˆ—äº‹ä»¶ï¼š*/
POLLERã€€ã€€   				//æŒ‡å®šçš„æ–‡ä»¶æè¿°ç¬¦å‘ç”Ÿé”™è¯¯ã€‚
POLLHUPã€€ã€€ 				//æŒ‡å®šçš„æ–‡ä»¶æè¿°ç¬¦æŒ‚èµ·äº‹ä»¶ã€‚
POLLNVALã€€ã€€				//æŒ‡å®šçš„æ–‡ä»¶æè¿°ç¬¦éæ³•ã€‚
/*è¿™äº›äº‹ä»¶åœ¨eventsåŸŸä¸­æ— æ„ä¹‰ï¼Œå› ä¸ºå®ƒä»¬åœ¨åˆé€‚çš„æ—¶å€™æ€»æ˜¯ä¼šä»reventsä¸­è¿”å›*/
```

ä½¿ç”¨poll()å’Œselect()ä¸ä¸€æ ·ï¼Œä½ ä¸éœ€è¦æ˜¾å¼åœ°è¯·æ±‚å¼‚å¸¸æƒ…å†µæŠ¥å‘Šã€‚
ã€€ã€€POLLIN  |  POLLPRIç­‰ä»·äºselect( )çš„è¯»äº‹ä»¶ï¼ŒPOLLOUT  | POLLWRBAND ç­‰ä»·äºselect( )çš„å†™äº‹ä»¶ã€‚POLLIN ç­‰ä»·äºPOLLRDNORM  |  POLLRDBANDï¼Œè€Œ POLLOUT åˆ™ç­‰ä»·äº POLLWRNORMã€‚ä¾‹å¦‚ï¼Œè¦åŒæ—¶ç›‘è§†ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦æ˜¯å¦å¯è¯»å’Œå¯å†™ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½® events ä¸ºPOLLIN | POLLOUTã€‚åœ¨ poll è¿”å›æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æ£€æŸ¥ revents ä¸­çš„æ ‡å¿—ï¼Œå¯¹åº”äºæ–‡ä»¶æè¿°ç¬¦è¯·æ±‚çš„ events ç»“æ„ä½“ã€‚å¦‚æœ POLLIN äº‹ä»¶è¢«è®¾ç½®ï¼Œåˆ™æ–‡ä»¶æè¿°ç¬¦å¯ä»¥è¢«è¯»å–è€Œä¸é˜»å¡ã€‚å¦‚æœ POLLOUT è¢«è®¾ç½®ï¼Œåˆ™æ–‡ä»¶æè¿°ç¬¦å¯ä»¥å†™å…¥è€Œä¸å¯¼è‡´é˜»å¡ã€‚è¿™äº›æ ‡å¿—å¹¶ä¸æ˜¯äº’æ–¥çš„ï¼šå®ƒä»¬å¯èƒ½è¢«åŒæ—¶è®¾ç½®ï¼Œè¡¨ç¤ºè¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦çš„è¯»å–å’Œå†™å…¥æ“ä½œéƒ½ä¼šæ­£å¸¸è¿”å›è€Œä¸é˜»å¡ã€‚

ã€€ã€€timeout å‚æ•°æŒ‡å®šç­‰å¾…çš„æ¯«ç§’æ•°ï¼Œæ— è®ºI/Oæ˜¯å¦å‡†å¤‡å¥½ï¼Œpoll éƒ½ä¼šè¿”å›ã€‚timeout æŒ‡å®šä¸ºè´Ÿæ•°å€¼è¡¨ç¤ºæ— é™è¶…æ—¶ï¼Œä½¿ poll( )ä¸€ç›´æŒ‚èµ·ç›´åˆ°ä¸€ä¸ªæŒ‡å®šäº‹ä»¶å‘ç”Ÿï¼›timeout ä¸º 0 æŒ‡ç¤º poll è°ƒç”¨ç«‹å³è¿”å›å¹¶åˆ—å‡ºå‡†å¤‡å¥½ I/O çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä½†å¹¶ä¸ç­‰å¾…å…¶å®ƒçš„äº‹ä»¶ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œpoll( ) å°±åƒå®ƒçš„åå­—é‚£æ ·ï¼Œä¸€æ—¦é€‰ä¸¾å‡ºæ¥ï¼Œç«‹å³è¿”å›ã€‚ 

è¿”å›å€¼å’Œé”™è¯¯ä»£ç 
ã€€ã€€æˆåŠŸæ—¶ï¼Œpoll( ) è¿”å›ç»“æ„ä½“ä¸­ revents åŸŸä¸ä¸º 0 çš„æ–‡ä»¶æè¿°ç¬¦ä¸ªæ•°ï¼›å¦‚æœåœ¨è¶…æ—¶å‰æ²¡æœ‰ä»»ä½•äº‹ä»¶å‘ç”Ÿï¼Œpoll( )è¿”å› 0ï¼›å¤±è´¥æ—¶ï¼Œpoll( )è¿”å›-1ï¼Œå¹¶è®¾ç½® errno ä¸ºä¸‹åˆ—å€¼ä¹‹ä¸€ï¼š

```c
EBADFã€€ã€€     //ä¸€ä¸ªæˆ–å¤šä¸ªç»“æ„ä½“ä¸­æŒ‡å®šçš„æ–‡ä»¶æè¿°ç¬¦æ— æ•ˆã€‚
EFAULTfdsã€€ã€€ //æŒ‡é’ˆæŒ‡å‘çš„åœ°å€è¶…å‡ºè¿›ç¨‹çš„åœ°å€ç©ºé—´ã€‚
EINTRã€€ã€€ã€€ã€€  //è¯·æ±‚çš„äº‹ä»¶ä¹‹å‰äº§ç”Ÿä¸€ä¸ªä¿¡å·ï¼Œè°ƒç”¨å¯ä»¥é‡æ–°å‘èµ·ã€‚
EINVALnfdsã€€ã€€//å‚æ•°è¶…å‡ºPLIMIT_NOFILEå€¼ã€‚
ENOMEMã€€ã€€    //å¯ç”¨å†…å­˜ä¸è¶³ï¼Œæ— æ³•å®Œæˆè¯·æ±‚ã€‚
```

## pollæµ‹è¯•

æœåŠ¡å™¨ç«¯

```c
/*************************************************************************
	> File Name: poll_server.c
	> Author: zhengdongqi
	> Mail: 
	> Created Time: Tue 09 Apr 2019 14:15:43 CST
 ************************************************************************/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <errno.h>

#include <netinet/in.h>
#include <arpa/inet.h>
#include <sys/socket.h>
#include <poll.h>
#include <unistd.h>
#include <sys/types.h>

#ifdef _DEBUG
#define DBG(fmt, args...) printf(fmt, ##args)
#else
#define DBG(fmt, args...)
#endif

#define IPADDR      "192.168.1.44"
#define PORT        8731
#define MAXSIZE     1024
#define LISTENQ     5
#define OPEN_MAX    1000
#define INFTIM      -1

/*å‡½æ•°å£°æ˜*/
/*åˆ›å»ºå¥—æ¥å­—å¹¶è¿›è¡Œç»‘å®š*/
int socket_bind(int port);
/*IOå¤šè·¯å¤ç”¨poll*/
void do_poll(int listenfd);
/*å¤„ç†å¤šä¸ªè¿æ¥*/
void handle_connect(struct pollfd *pfds, int num);

int main() {
    DBG("\033[33mæƒ³è¦å°ğŸŒ¹å—?\033[0m\n");
    fflush(stdout);
    int  listenfd;
    struct sockaddr_in socket_addr;
    listenfd = socket_bind(PORT);
    listen(listenfd, LISTENQ);
    do_poll(listenfd);
    return 0;
}

/*åˆ›å»ºå¥—æ¥å­—å¹¶è¿›è¡Œç»‘å®š*/
int socket_bind(int port) {
    int  listenfd;
    struct sockaddr_in socket_addr;
    listenfd = socket(AF_INET, SOCK_STREAM, 0);
    if (listenfd == -1) {
        DBG("socket_bind->\033[31må¥—æ¥å­—åˆ›å»ºå¤±è´¥: %s\033[0m\n", strerror(errno));
        return -1;
    }
    memset(&socket_addr, 0, sizeof(socket_addr));
    socket_addr.sin_family = AF_INET;
    socket_addr.sin_port = htons(port);
  	socket_addr.sin_addr.s_addr = htonl(INADDR_ANY);
 	//ç«¯å£é‡ç”¨
    int reuse = 1;
    if (setsockopt(listenfd, SOL_SOCKET, SO_REUSEADDR, &reuse, sizeof(reuse)) == -1) {
        DBG("socket_bind->\033[31mè®¾ç½®ç«¯å£é‡ç”¨å¤±è´¥: %s\033[0m\n", strerror(errno));
        close(listenfd);
        return -1;
    }
    if (bind(listenfd, (struct sockaddr*)&socket_addr, sizeof(socket_addr)) == -1) {
        DBG("socket_bind->\033[31mç»‘å®šå¤±è´¥: %s\033[0m\n", strerror(errno));
        return -1;
    }
    return listenfd;
}
/*IOå¤šè·¯å¤ç”¨ç ´poll*/
void do_poll(int listenfd) {
    int poll_fd;
    struct sockaddr_in poll_addr;
    struct pollfd pfds[OPEN_MAX];
    int maxfd;
    int i;
    int nready;
    //æ·»åŠ ç›‘å¬æè¿°ç¬¦
    pfds[0].fd = listenfd;
    pfds[0].events = POLLIN;
    //åˆå§‹åŒ–å®¢æˆ·è¿æ¥æè¿°ç¬¦
    for (i = 1; i < OPEN_MAX; i++) {
        pfds[i].fd = -1;
    }
    maxfd = 0;
    //å¾ªç¯å¤„ç†
    for ( ; ; ) {
        //è·å–å¯ç”¨æè¿°ç¬¦çš„ä¸ªæ•°
        nready = poll(pfds, maxfd+1, INFTIM);
        if (nready == -1) {
            DBG("do_poll->\033[31mpoll error\033[0m\n");
            return ;
        }
        //æµ‹è¯•ç›‘å¬æè¿°ç¬¦æ˜¯å¦å‡†å¤‡å¥½
        if (pfds[0].revents & POLLIN) {
            socklen_t len = sizeof(poll_addr);
            //æ¥å—æ–°çš„è¿æ¥
            if ((poll_fd = accept(listenfd, (struct sockaddr*)&poll_addr, &len)) == -1) {
                if (errno == EINTR)
                    continue;
                else {
                   DBG("do_poll->\033[31maccept error\033[0m\n");
                   return ;
                }
            }
            DBG("do_poll->\033[33maccept a new client: %s->%d\033[0m\n", inet_ntoa(poll_addr.sin_addr), ntohs(poll_addr.sin_port));
            //å°†æ–°çš„è¿æ¥æè¿°ç¬¦æ·»åŠ åˆ°æ•°ç»„ä¸­
            for (i = 1; i < OPEN_MAX; i++) {
                if (pfds[i].fd < 0) {
                    pfds[i].fd = poll_fd;
                    break;
                }
            }
            if (i == OPEN_MAX) {
                DBG("\033[34mç´¯æ­»äº†ğŸ˜¢\033[0m\n");
                return ;
            }
            //å°†æ–°çš„æè¿°ç¬¦æ·»åŠ åˆ°è¯»æè¿°ç¬¦é›†åˆä¸­
            pfds[i].events = POLLIN;
            //è®°å½•å®¢æˆ·è¿æ¥å¥—æ¥å­—çš„ä¸ªæ•°
            maxfd = (i > maxfd ? i : maxfd);
            if (--nready <= 0)
                continue;
        }
        //å¤„ç†å®¢æˆ·è¿æ¥
        handle_connect(pfds,maxfd);
    }
}

void handle_connect(struct pollfd *pfds, int num) {
    int i, n;
    char buf[MAXSIZE];
    memset(buf, 0, MAXSIZE);
    for (i = 1; i <= num; i++) {
        if (pfds[i].fd < 0)
            continue;
        //æµ‹è¯•å®¢æˆ·æè¿°ç¬¦æ˜¯å¦å‡†å¤‡å¥½
        if (pfds[i].revents & POLLIN) {
            //æ¥æ”¶å®¢æˆ·ç«¯å‘é€çš„ä¿¡æ¯
            n = read(pfds[i].fd, buf, MAXSIZE);
            if (n == 0) {
                close(pfds[i].fd);
                pfds[i].fd = -1;
                continue;
            }
            DBG("handle_connect->\033[33mread msg is: %s\033[0m", buf);
            write(STDOUT_FILENO, buf, n);
            //å‘å®¢æˆ·ç«¯å‘é€buf
            write(pfds[i].fd, buf, n);
        }
    }
}
```

å®¢æˆ·ç«¯

```c
/*************************************************************************
	> File Name: poll_client.c
	> Author: zhengdongqi
	> Mail: 1821260963@qq.com
	> Created Time: Tue 09 Apr 2019 14:19:14 CST
 ************************************************************************/

#include <netinet/in.h>
#include <arpa/inet.h>
#include <sys/socket.h>
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <poll.h>
#include <time.h>
#include <unistd.h>
#include <sys/types.h>

#ifdef _DEBUG
#define DBG(fmt, args...) printf(fmt, ##args)
#else
#define DBG(fmt, args...)
#endif

#define MAXSIZE     1024
#define IPADDR      "192.168.1.44"
#define PORT        8731
/*å¤„ç†è¿æ¥*/
void handle_connect(int sockfd);

int main() {
    DBG("\033[33mé€ä½ ä¸€æœµå°èŠ±ğŸŒ¹\033[0m\n");
    fflush(stdout);
    int socket_fd;
    struct sockaddr_in  socket_addr;
    socket_fd = socket(AF_INET, SOCK_STREAM, 0);
    memset(&socket_addr, 0, sizeof(socket_addr));
    socket_addr.sin_family = AF_INET;
    socket_addr.sin_port = htons(PORT);
    socket_addr.sin_addr.s_addr = inet_addr(IPADDR);
    connect(socket_fd, (struct sockaddr*)&socket_addr,sizeof(socket_addr));
    //å¤„ç†è¿æ¥æè¿°ç¬¦
    handle_connect(socket_fd);
    return 0;
}
/*å¤„ç†è¿æ¥*/
void handle_connect(int socket_fd) {
    char sendline[MAXSIZE], recvline[MAXSIZE];
    struct pollfd pfds[2];
    int n;
    //æ·»åŠ è¿æ¥æè¿°ç¬¦
    pfds[0].fd = socket_fd;
    pfds[0].events = POLLIN;
    //æ·»åŠ æ ‡å‡†è¾“å…¥æè¿°ç¬¦
    pfds[1].fd = STDIN_FILENO;
    pfds[1].events = POLLIN;
    for (; ;) {
        poll(pfds, 2, -1);
        if (pfds[0].revents & POLLIN) {
            n = read(socket_fd, recvline, MAXSIZE);
            if (n == 0) {
                DBG("handle_connect->\033[31mæœåŠ¡å™¨å·²å…³é—­\033[0m\n");
                close(socket_fd);
            }
            DBG("handle_connect->\033[33mrecvline: %s\033[0m", recvline);
            write(STDOUT_FILENO, recvline, n);
        }
        //æµ‹è¯•æ ‡å‡†è¾“å…¥æ˜¯å¦å‡†å¤‡å¥½
        if (pfds[1].revents & POLLIN) {
            n = read(STDIN_FILENO, sendline, MAXSIZE);
            if (n == 0) {
                shutdown(socket_fd, SHUT_WR);
                continue;
            }
            DBG("handle_connect->\033[33msendline: %s\033[0m", sendline);
            write(socket_fd, sendline, n);
        }
    }
}
```

## pollè¿è¡Œ

![poll_server](./pic/poll_server.png)

![poll_client](./pic/poll_client.png)

## pollæ€»ç»“

`pollæœ¬è´¨ä¸Šå’Œselectæ²¡æœ‰åŒºåˆ«ï¼Œå®ƒå°†ç”¨æˆ·ä¼ å…¥çš„æ•°ç»„æ‹·è´åˆ°å†…æ ¸ç©ºé—´`ï¼Œç„¶åæŸ¥è¯¢æ¯ä¸ªfdå¯¹åº”çš„è®¾å¤‡çŠ¶æ€ï¼Œå¦‚æœè®¾å¤‡å°±ç»ªåˆ™åœ¨è®¾å¤‡ç­‰å¾…é˜Ÿåˆ—ä¸­åŠ å…¥ä¸€é¡¹å¹¶ç»§ç»­éå†ï¼Œå¦‚æœéå†å®Œæ‰€æœ‰fdåæ²¡æœ‰å‘ç°å°±ç»ªè®¾å¤‡ï¼Œåˆ™æŒ‚èµ·å½“å‰è¿›ç¨‹ï¼Œç›´åˆ°è®¾å¤‡å°±ç»ªæˆ–è€…ä¸»åŠ¨è¶…æ—¶ï¼Œè¢«å”¤é†’åå®ƒåˆè¦å†æ¬¡éå†fdã€‚è¿™ä¸ªè¿‡ç¨‹ç»å†äº†å¤šæ¬¡æ— è°“çš„éå†ã€‚ 

å®ƒæ²¡æœ‰æœ€å¤§è¿æ¥æ•°çš„é™åˆ¶ï¼Œ`åŸå› æ˜¯å®ƒæ˜¯åŸºäºé“¾è¡¨æ¥å­˜å‚¨çš„`ï¼Œä½†æ˜¯åŒæ ·æœ‰ä¸€ä¸ªç¼ºç‚¹ï¼š

`1ï¼‰å¤§é‡çš„fdçš„æ•°ç»„è¢«æ•´ä½“å¤åˆ¶äºç”¨æˆ·æ€å’Œå†…æ ¸åœ°å€ç©ºé—´ä¹‹é—´`ï¼Œè€Œä¸ç®¡è¿™æ ·çš„å¤åˆ¶æ˜¯ä¸æ˜¯æœ‰æ„ä¹‰ã€‚

`2ï¼‰pollè¿˜æœ‰ä¸€ä¸ªç‰¹ç‚¹æ˜¯â€œæ°´å¹³è§¦å‘â€`ï¼Œå¦‚æœæŠ¥å‘Šäº†fdåï¼Œæ²¡æœ‰è¢«å¤„ç†ï¼Œé‚£ä¹ˆä¸‹æ¬¡pollæ—¶ä¼šå†æ¬¡æŠ¥å‘Šè¯¥fdã€‚ 

æ³¨æ„ï¼šä»ä¸Šé¢çœ‹ï¼Œselectå’Œpolléƒ½éœ€è¦åœ¨è¿”å›åï¼Œ`é€šè¿‡éå†æ–‡ä»¶æè¿°ç¬¦æ¥è·å–å·²ç»å°±ç»ªçš„socket`ã€‚äº‹å®ä¸Šï¼Œ`åŒæ—¶è¿æ¥çš„å¤§é‡å®¢æˆ·ç«¯åœ¨ä¸€æ—¶åˆ»å¯èƒ½åªæœ‰å¾ˆå°‘çš„å¤„äºå°±ç»ªçŠ¶æ€`ï¼Œå› æ­¤éšç€ç›‘è§†çš„æè¿°ç¬¦æ•°é‡çš„å¢é•¿ï¼Œå…¶æ•ˆç‡ä¹Ÿä¼šçº¿æ€§ä¸‹é™ã€‚

# 5ã€IOå¤šè·¯å¤ç”¨epoll

## epollåŸç†

epollæ˜¯åœ¨2.6å†…æ ¸ä¸­æå‡ºçš„ï¼Œæ˜¯ä¹‹å‰çš„selectå’Œpollçš„å¢å¼ºç‰ˆæœ¬ã€‚ç›¸å¯¹äºselectå’Œpollæ¥è¯´ï¼Œepollæ›´åŠ çµæ´»ï¼Œæ²¡æœ‰æè¿°ç¬¦é™åˆ¶ã€‚epollä½¿ç”¨ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ç®¡ç†å¤šä¸ªæè¿°ç¬¦ï¼Œå°†ç”¨æˆ·å…³ç³»çš„æ–‡ä»¶æè¿°ç¬¦çš„äº‹ä»¶å­˜æ”¾åˆ°å†…æ ¸çš„ä¸€ä¸ªäº‹ä»¶è¡¨ä¸­ï¼Œè¿™æ ·åœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„copyåªéœ€ä¸€æ¬¡ã€‚

## epollå‡½æ•°

epollæ“ä½œè¿‡ç¨‹éœ€è¦ä¸‰ä¸ªæ¥å£ï¼Œåˆ†åˆ«å¦‚ä¸‹ï¼š

```c
#include <sys/epoll.h>
int epoll_create(int size);
int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event);
int epoll_wait(int epfd, struct epoll_event * events, int maxevents, int timeout);
```

**ï¼ˆ1ï¼‰ int epoll_create(int size);**
ã€€ã€€åˆ›å»ºä¸€ä¸ªepollçš„å¥æŸ„ï¼Œsizeç”¨æ¥å‘Šè¯‰å†…æ ¸è¿™ä¸ªç›‘å¬çš„æ•°ç›®ä¸€å…±æœ‰å¤šå¤§ã€‚è¿™ä¸ªå‚æ•°ä¸åŒäºselect()ä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œç»™å‡ºæœ€å¤§ç›‘å¬çš„fd+1çš„å€¼ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“åˆ›å»ºå¥½epollå¥æŸ„åï¼Œå®ƒå°±æ˜¯ä¼šå ç”¨ä¸€ä¸ªfdå€¼ï¼Œåœ¨linuxä¸‹å¦‚æœæŸ¥çœ‹/proc/è¿›ç¨‹id/fd/ï¼Œæ˜¯èƒ½å¤Ÿçœ‹åˆ°è¿™ä¸ªfdçš„ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨å®Œepollåï¼Œå¿…é¡»è°ƒç”¨close()å…³é—­ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´fdè¢«è€—å°½ã€‚

**ï¼ˆ2ï¼‰int epoll_ctl(int epfd,  int op,  int fd,  struct epoll_event  *event);**
ã€€ã€€epollçš„äº‹ä»¶æ³¨å†Œå‡½æ•°ï¼Œå®ƒä¸åŒä¸select()æ˜¯åœ¨ç›‘å¬äº‹ä»¶æ—¶å‘Šè¯‰å†…æ ¸è¦ç›‘å¬ä»€ä¹ˆç±»å‹çš„äº‹ä»¶epollçš„äº‹ä»¶æ³¨å†Œå‡½æ•°ï¼Œå®ƒä¸åŒä¸select()æ˜¯åœ¨ç›‘å¬äº‹ä»¶æ—¶å‘Šè¯‰å†…æ ¸è¦ç›‘å¬ä»€ä¹ˆç±»å‹çš„äº‹ä»¶ï¼Œè€Œæ˜¯åœ¨è¿™é‡Œå…ˆæ³¨å†Œè¦ç›‘å¬çš„äº‹ä»¶ç±»å‹ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯epoll_create()çš„è¿”å›å€¼ï¼Œç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºåŠ¨ä½œï¼Œç”¨ä¸‰ä¸ªå®æ¥è¡¨ç¤ºï¼š

```c
EPOLL_CTL_ADDï¼š//æ³¨å†Œæ–°çš„fdåˆ°epfdä¸­ï¼›
EPOLL_CTL_MODï¼š//å·²ç»æ³¨å†Œçš„fdçš„ç›‘å¬äº‹ä»¶ï¼›
EPOLL_CTL_DELï¼š//pfdä¸­åˆ é™¤ä¸€ä¸ªfdï¼›
```

ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯éœ€è¦ç›‘å¬çš„fdï¼Œç¬¬å››ä¸ªå‚æ•°æ˜¯å‘Šè¯‰å†…æ ¸éœ€è¦ç›‘å¬ä»€ä¹ˆäº‹ï¼Œstruct epoll_eventç»“æ„å¦‚ä¸‹ï¼š

```c
struct epoll_event {
  __uint32_t events;  /* Epoll events */
  epoll_data_t data;  /* User data variable */
};
```

eventså¯ä»¥æ˜¯ä»¥ä¸‹å‡ ä¸ªå®çš„é›†åˆï¼š

```c
EPOLLIN ï¼š//è¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å¯ä»¥è¯»ï¼ˆåŒ…æ‹¬å¯¹ç«¯SOCKETæ­£å¸¸å…³é—­ï¼‰ï¼›
EPOLLOUTï¼š//è¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å¯ä»¥å†™ï¼›
EPOLLPRIï¼š//è¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦æœ‰ç´§æ€¥çš„æ•°æ®å¯è¯»ï¼ˆè¿™é‡Œåº”è¯¥è¡¨ç¤ºæœ‰å¸¦å¤–æ•°æ®åˆ°æ¥ï¼‰ï¼›
EPOLLERRï¼š//è¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å‘ç”Ÿé”™è¯¯ï¼›
EPOLLHUPï¼š//è¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦è¢«æŒ‚æ–­ï¼›
EPOLLETï¼š //å°†EPOLLè®¾ä¸ºè¾¹ç¼˜è§¦å‘(Edge Triggered)æ¨¡å¼ï¼Œè¿™æ˜¯ç›¸å¯¹äºæ°´å¹³è§¦å‘(Level Triggered)æ¥è¯´çš„ã€‚
EPOLLONESHOTï¼š//åªç›‘å¬ä¸€æ¬¡äº‹ä»¶ï¼Œå½“ç›‘å¬å®Œè¿™æ¬¡äº‹ä»¶ä¹‹åï¼Œå¦‚æœè¿˜éœ€è¦ç»§ç»­ç›‘å¬è¿™ä¸ªsocketçš„è¯ï¼Œéœ€è¦å†æ¬¡æŠŠè¿™ä¸ªsocketåŠ å…¥åˆ°EPOLLé˜Ÿåˆ—é‡Œ
```

**ï¼ˆ3ï¼‰ int epoll_wait(int epfd, struct epoll_event \* events, int maxevents, int timeout);**
ã€€ã€€ç­‰å¾…äº‹ä»¶çš„äº§ç”Ÿï¼Œç±»ä¼¼äºselect()è°ƒç”¨ã€‚å‚æ•°eventsç”¨æ¥ä»å†…æ ¸å¾—åˆ°äº‹ä»¶çš„é›†åˆï¼Œmaxeventså‘Šä¹‹å†…æ ¸è¿™ä¸ªeventsæœ‰å¤šå¤§ï¼Œè¿™ä¸ªmaxeventsçš„å€¼ä¸èƒ½å¤§äºåˆ›å»ºepoll_create()æ—¶çš„sizeï¼Œå‚æ•°timeoutæ˜¯è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼Œ0ä¼šç«‹å³è¿”å›ï¼Œ-1å°†ä¸ç¡®å®šï¼Œä¹Ÿæœ‰è¯´æ³•è¯´æ˜¯æ°¸ä¹…é˜»å¡ï¼‰ã€‚è¯¥å‡½æ•°è¿”å›éœ€è¦å¤„ç†çš„äº‹ä»¶æ•°ç›®ï¼Œå¦‚è¿”å›0è¡¨ç¤ºå·²è¶…æ—¶ã€‚

## epollæ¨¡å¼

â€‹	epollå¯¹æ–‡ä»¶æè¿°ç¬¦çš„æ“ä½œæœ‰ä¸¤ç§æ¨¡å¼ï¼šLTï¼ˆlevel triggerï¼‰å’ŒETï¼ˆedge triggerï¼‰ã€‚LTæ¨¡å¼æ˜¯é»˜è®¤æ¨¡å¼ï¼ŒLTæ¨¡å¼ä¸ETæ¨¡å¼çš„åŒºåˆ«å¦‚ä¸‹ï¼š

ã€€ã€€LTæ¨¡å¼ï¼š**å½“epoll_waitæ£€æµ‹åˆ°æè¿°ç¬¦äº‹ä»¶å‘ç”Ÿå¹¶å°†æ­¤äº‹ä»¶é€šçŸ¥åº”ç”¨ç¨‹åºï¼Œåº”ç”¨ç¨‹åºå¯ä»¥ä¸ç«‹å³å¤„ç†è¯¥äº‹ä»¶ã€‚ä¸‹æ¬¡è°ƒç”¨epoll_waitæ—¶ï¼Œä¼šå†æ¬¡å“åº”åº”ç”¨ç¨‹åºå¹¶é€šçŸ¥æ­¤äº‹ä»¶ã€‚**

ã€€ã€€ETæ¨¡å¼ï¼š**å½“epoll_waitæ£€æµ‹åˆ°æè¿°ç¬¦äº‹ä»¶å‘ç”Ÿå¹¶å°†æ­¤äº‹ä»¶é€šçŸ¥åº”ç”¨ç¨‹åºï¼Œåº”ç”¨ç¨‹åºå¿…é¡»ç«‹å³å¤„ç†è¯¥äº‹ä»¶ã€‚å¦‚æœä¸å¤„ç†ï¼Œä¸‹æ¬¡è°ƒç”¨epoll_waitæ—¶ï¼Œä¸ä¼šå†æ¬¡å“åº”åº”ç”¨ç¨‹åºå¹¶é€šçŸ¥æ­¤äº‹ä»¶ã€‚**

ã€€ã€€**ETæ¨¡å¼åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šå‡å°‘äº†epolläº‹ä»¶è¢«é‡å¤è§¦å‘çš„æ¬¡æ•°ï¼Œå› æ­¤æ•ˆç‡è¦æ¯”LTæ¨¡å¼é«˜ã€‚epollå·¥ä½œåœ¨ETæ¨¡å¼çš„æ—¶å€™ï¼Œå¿…é¡»ä½¿ç”¨éé˜»å¡å¥—æ¥å£ï¼Œä»¥é¿å…ç”±äºä¸€ä¸ªæ–‡ä»¶å¥æŸ„çš„é˜»å¡è¯»/é˜»å¡å†™æ“ä½œæŠŠå¤„ç†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦çš„ä»»åŠ¡é¥¿æ­»ã€‚**

## epollæµ‹è¯•

ç¼–å†™ä¸€ä¸ªæœåŠ¡å™¨å›å°„ç¨‹åºechoï¼Œç»ƒä¹ epollè¿‡ç¨‹ã€‚

```c
/*************************************************************************
	> File Name: epoll_server.c
	> Author: zhengdongqi
	> Mail: 
	> Created Time: Mon 08 Apr 2019 19:10:21 CST
 ************************************************************************/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <errno.h>

#include <netinet/in.h>
#include <sys/socket.h>
#include <arpa/inet.h>
#include <sys/epoll.h>
#include <unistd.h>
#include <sys/types.h>

#ifdef _DEBUG
#define DBG(fmt, args...) printf(fmt, ##args)
#else
#define DBG(fmt, args...)
#endif

#define IPADDR      "192.168.1.44"
#define PORT        8731
#define MAXSIZE     1024
#define LISTENQ     5
#define FDSIZE      1000
#define EPOLLEVENTS 100

/*å‡½æ•°å£°æ˜*/
/*åˆ›å»ºå¥—æ¥å­—å¹¶è¿›è¡Œç»‘å®š*/
int socket_bind(int port);
/*IOå¤šè·¯å¤ç”¨epoll*/
void do_epoll(int listenfd);
/*äº‹ä»¶å¤„ç†å‡½æ•°*/
void handle_events(int epollfd, struct epoll_event *events, int num, int listenfd, char *buf);
/*å¤„ç†æ¥æ”¶åˆ°çš„è¿æ¥*/
void handle_accpet(int epollfd, int listenfd);
/*è¯»å¤„ç†*/
void do_read(int epollfd, int fd, char *buf);
/*å†™å¤„ç†*/
void do_write(int epollfd, int fd, char *buf);
/*æ·»åŠ äº‹ä»¶*/
void add_event(int epollfd, int fd, int state);
/*ä¿®æ”¹äº‹ä»¶*/
void modify_event(int epollfd, int fd, int state);
/*åˆ é™¤äº‹ä»¶*/
void delete_event(int epollfd, int fd, int state);

int main() {
    int  listenfd;
    listenfd = socket_bind(PORT);
    listen(listenfd, LISTENQ);
    do_epoll(listenfd);
    return 0;
}
/*åˆ›å»ºå¥—æ¥å­—å¹¶è¿›è¡Œç»‘å®š*/
int socket_bind(int port) {
    int  listenfd;
    struct sockaddr_in socket_addr;
    listenfd = socket(AF_INET, SOCK_STREAM, 0);
    if (listenfd == -1) {
        DBG("socket_bind->\033[31må¥—æ¥å­—åˆ›å»ºå¤±è´¥: %s\033[0m\n", strerror(errno));
        return -1;
    }
    memset(&socket_addr, 0, sizeof(socket_addr));
    socket_addr.sin_family = AF_INET;
    socket_addr.sin_port = htons(port);
  	socket_addr.sin_addr.s_addr = htonl(INADDR_ANY);
 	//ç«¯å£é‡ç”¨
    int reuse = 1;
    if (setsockopt(listenfd, SOL_SOCKET, SO_REUSEADDR, &reuse, sizeof(reuse)) == -1) {
        DBG("socket_bind->\033[31mè®¾ç½®ç«¯å£é‡ç”¨å¤±è´¥: %s\033[0m\n", strerror(errno));
        close(listenfd);
        return -1;
    }
    if (bind(listenfd, (struct sockaddr*)&socket_addr, sizeof(socket_addr)) == -1) {
        DBG("socket_bind->\033[31mç»‘å®šå¤±è´¥: %s\033[0m\n", strerror(errno));
        return -1;
    }
    return listenfd;
}
/*IOå¤šè·¯å¤ç”¨epoll*/
void do_epoll(int listenfd) {
    int epollfd;
    struct epoll_event events[EPOLLEVENTS];
    int ret;
    char buf[MAXSIZE];
    memset(buf, 0, MAXSIZE);
    //åˆ›å»ºä¸€ä¸ªæè¿°ç¬¦
    epollfd = epoll_create(FDSIZE);
    //æ·»åŠ ç›‘å¬æè¿°ç¬¦äº‹ä»¶
    add_event(epollfd, listenfd, EPOLLIN);
    for ( ; ; ) {
        //è·å–å·²ç»å‡†å¤‡å¥½çš„æè¿°ç¬¦äº‹ä»¶
        ret = epoll_wait(epollfd, events, EPOLLEVENTS, -1);
        handle_events(epollfd, events, ret, listenfd, buf);
    }
    close(epollfd);
}
/*äº‹ä»¶å¤„ç†å‡½æ•°*/
void handle_events(int epollfd, struct epoll_event *events, int num, int listenfd, char *buf) {
    int i;
    int fd;
    //è¿›è¡Œé€‰å¥½éå†
    for (i = 0; i < num; i++) {
        fd = events[i].data.fd;
        //æ ¹æ®æè¿°ç¬¦çš„ç±»å‹å’Œäº‹ä»¶ç±»å‹è¿›è¡Œå¤„ç†
        if ((fd == listenfd) && (events[i].events & EPOLLIN))
            handle_accpet(epollfd, listenfd);
        else if (events[i].events & EPOLLIN)
            do_read(epollfd, fd, buf);
        else if (events[i].events & EPOLLOUT)
            do_write(epollfd, fd, buf);
    }
}
/*å¤„ç†æ¥æ”¶åˆ°çš„è¿æ¥*/
void handle_accpet(int epollfd, int listenfd) {
  	struct sockaddr_in socket_addr;
    int len = sizeof(struct sockaddr_in), fd;
    fd = accept(listenfd, (struct sockaddr*)&socket_addr, (socklen_t *)&len);
    if (fd == -1) {
        DBG("handle_accpet->\033[31mæ¥å—å¥—æ¥å­—å¤±è´¥: %s\033[0m", strerror(errno));
    } else {
        DBG("handle_accpet->\033[33mæ£€æŸ¥åˆ°ä¸€ä¸ªæ–°ç”¨æˆ·: %s->%d\033[0m\n", inet_ntoa(socket_addr.sin_addr), ntohs(socket_addr.sin_port));

        //æ·»åŠ ä¸€ä¸ªå®¢æˆ·æè¿°ç¬¦å’Œäº‹ä»¶
        add_event(epollfd, fd, EPOLLIN);
    }
}
/*è¯»å¤„ç†*/
void do_read(int epollfd, int fd, char *buf) {
    int nread;
    nread = read(fd, buf, MAXSIZE);
    if (nread == -1) {
        DBG("do_read->\033[31mè¯»âŒ\033[0m\n");
      	fflush(stdout);
        close(fd);
        delete_event(epollfd, fd, EPOLLIN);
    } else if (nread == 0) {
        DBG("\033[33mç”¨æˆ·å·²ä¸‹çº¿\033[0m\n");
        close(fd);
        delete_event(epollfd, fd, EPOLLIN);
    } else {
        DBG("do_read->\033[33mread: %s\033[0m", buf);
        //ä¿®æ”¹æè¿°ç¬¦å¯¹åº”çš„äº‹ä»¶ï¼Œç”±è¯»æ”¹ä¸ºå†™
        modify_event(epollfd, fd, EPOLLOUT);
    }
}
/*å†™å¤„ç†*/
void do_write(int epollfd, int fd, char *buf) {
    int nwrite;
    nwrite = write(fd, buf, strlen(buf));
    if (nwrite == -1) {
        DBG("do_write->\033[31mâŒ\033[0m\n");
      	fflush(stdout);
        close(fd);
        delete_event(epollfd, fd, EPOLLOUT);
    } else
        DBG("do_write->\033[33mwrite: %s\033[0m", buf);
        modify_event(epollfd, fd, EPOLLIN);
    memset(buf,0,MAXSIZE);
}
/*æ·»åŠ äº‹ä»¶*/
void add_event(int epollfd, int fd, int state) {
    struct epoll_event ev;
    ev.events = state;
    ev.data.fd = fd;
    epoll_ctl(epollfd, EPOLL_CTL_ADD, fd,&ev);
}
/*åˆ é™¤äº‹ä»¶*/
void delete_event(int epollfd, int fd, int state) {
    struct epoll_event ev;
    ev.events = state;
    ev.data.fd = fd;
    epoll_ctl(epollfd, EPOLL_CTL_DEL, fd,&ev);
}
/*ä¿®æ”¹äº‹ä»¶*/
void modify_event(int epollfd, int fd, int state) {
    struct epoll_event ev;
    ev.events = state;
    ev.data.fd = fd;
    epoll_ctl(epollfd, EPOLL_CTL_MOD, fd,&ev);
}
```

å®¢æˆ·ç«¯

```c
/*************************************************************************
	> File Name: epoll_client.c
	> Author: zhengdongqi
	> Mail: 
	> Created Time: Mon 08 Apr 2019 19:15:59 CST
 ************************************************************************/
#include <netinet/in.h>
#include <sys/socket.h>
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <sys/epoll.h>
#include <time.h>
#include <unistd.h>
#include <sys/types.h>
#include <arpa/inet.h>

#ifdef _DEBUG
#define DBG(fmt, args...) printf(fmt, ##args)
#else
#define DBG(fmt, args...)
#endif

#define MAXSIZE     1024
#define IPADDR   	"192.168.1.44"
#define PORT   		8731
#define FDSIZE      1024
#define EPOLLEVENTS 20

/*å¤„ç†è¿æ¥*/
void handle_connection(int sockfd);
/*å¤„ç†äº‹ä»¶*/
void handle_events(int epollfd, struct epoll_event *events, int num, int sockfd, char *buf);
/*è¯»å¤„ç†*/
void do_read(int epollfd, int fd, int sockfd, char *buf);
/*å†™å¤„ç†*/
void do_write(int epollfd, int fd, int sockfd, char *buf);
/*æ·»åŠ äº‹ä»¶*/
void add_event(int epollfd, int fd, int state);
/*åˆ é™¤äº‹ä»¶*/
void delete_event(int epollfd, int fd, int state);
/*ä¿®æ”¹äº‹ä»¶*/
void modify_event(int epollfd, int fd, int state);

int main() {
    int socket_fd;
    struct sockaddr_in  socket_addr;
    socket_fd = socket(AF_INET, SOCK_STREAM, 0);
    memset(&socket_addr, 0, sizeof(socket_addr));
    socket_addr.sin_family = AF_INET;
    socket_addr.sin_port = htons(PORT);
  	socket_addr.sin_addr.s_addr = inet_addr(IPADDR);
    connect(socket_fd, (struct sockaddr*)&socket_addr, sizeof(socket_addr));
    //å¤„ç†è¿æ¥
    handle_connection(socket_fd);
    close(socket_fd);
    return 0;
}
/*å¤„ç†è¿æ¥*/
void handle_connection(int sockfd) {
    int epollfd;
    struct epoll_event events[EPOLLEVENTS];
    char buf[MAXSIZE];
    int ret;
    epollfd = epoll_create(FDSIZE);
    add_event(epollfd, STDIN_FILENO, EPOLLIN);
    for ( ; ; ) {
        ret = epoll_wait(epollfd, events, EPOLLEVENTS, -1);
        handle_events(epollfd, events, ret, sockfd, buf);
    }
    close(epollfd);
}
/*å¤„ç†äº‹ä»¶*/
void handle_events(int epollfd, struct epoll_event *events, int num, int sockfd, char *buf) {
    int fd;
    int i;
    for (i = 0;i < num;i++) {
        fd = events[i].data.fd;
        if (events[i].events & EPOLLIN)
            do_read(epollfd, fd, sockfd, buf);
        else if (events[i].events & EPOLLOUT)
            do_write(epollfd, fd, sockfd, buf);
    }
}
/*è¯»å¤„ç†*/
void do_read(int epollfd, int fd, int sockfd, char *buf) {
    int nread;
    nread = read(fd,buf,MAXSIZE);
    if (nread == -1) {
        DBG("do_read->\033[31mâŒ\033[0m\n");
		fflush(stdout);
        close(fd);
    } else if (nread == 0) {
        DBG("do_read->\033[31mæœåŠ¡å™¨å…³é—­\033[0m\n");
        close(fd);
    } else {
        if (fd == STDIN_FILENO) {
            DBG("do_read->\033[32mread: %s\033[0m", buf);
            add_event(epollfd, sockfd, EPOLLOUT);
        } else {
            delete_event(epollfd, sockfd, EPOLLIN);
            add_event(epollfd, STDOUT_FILENO, EPOLLOUT);
        }
    }
}
/*å†™å¤„ç†*/
void do_write(int epollfd, int fd, int sockfd, char *buf) {
    int nwrite;
    nwrite = write(fd, buf, strlen(buf));
    if (nwrite == -1) {
        DBG("do_write->\033[31mâŒ\033[0m\n");
 		fflush(stdout);
        close(fd);
    } else {
        if (fd == STDOUT_FILENO) {
            DBG("do_write->\033[32mwrite: %s\033[0m", buf);
            delete_event(epollfd, fd, EPOLLOUT);
        } else {
            DBG("do_write->\033[32mwrite: %s\033[0m", buf);
            modify_event(epollfd, fd, EPOLLIN);
        }
    }
    memset(buf, 0, MAXSIZE);
}
/*æ·»åŠ äº‹ä»¶*/
void add_event(int epollfd, int fd, int state) {
    struct epoll_event ev;
    ev.events = state;
    ev.data.fd = fd;
    epoll_ctl(epollfd, EPOLL_CTL_ADD, fd, &ev);
}
/*åˆ é™¤äº‹ä»¶*/
void delete_event(int epollfd, int fd, int state) {
    struct epoll_event ev;
    ev.events = state;
    ev.data.fd = fd;
    epoll_ctl(epollfd, EPOLL_CTL_DEL, fd,&ev);
}
/*ä¿®æ”¹äº‹ä»¶*/
void modify_event(int epollfd, int fd, int state) {
    struct epoll_event ev;
    ev.events = state;
    ev.data.fd = fd;
    epoll_ctl(epollfd, EPOLL_CTL_MOD, fd, &ev);
}
```

## epollè¿è¡Œ

![epoll_server](./pic/epoll_server.png)

![epoll_clent](./pic/epoll_clent.png)

## epollæ€»ç»“

epollçš„ä¼˜ç‚¹ï¼š

`1ã€æ²¡æœ‰æœ€å¤§å¹¶å‘è¿æ¥çš„é™åˆ¶`ï¼Œèƒ½æ‰“å¼€çš„FDçš„ä¸Šé™è¿œå¤§äº1024ï¼ˆ1Gçš„å†…å­˜ä¸Šèƒ½ç›‘å¬çº¦10ä¸‡ä¸ªç«¯å£ï¼‰ã€‚

`2ã€æ•ˆç‡æå‡ï¼Œä¸æ˜¯è½®è¯¢çš„æ–¹å¼ï¼Œä¸ä¼šéšç€FDæ•°ç›®çš„å¢åŠ æ•ˆç‡ä¸‹é™`ã€‚

ã€€ã€€åªæœ‰æ´»è·ƒå¯ç”¨çš„FDæ‰ä¼šè°ƒç”¨callbackå‡½æ•°ï¼›`å³Epollæœ€å¤§çš„ä¼˜ç‚¹å°±åœ¨äºå®ƒåªç®¡ä½ â€œæ´»è·ƒâ€çš„è¿æ¥ï¼Œè€Œè·Ÿè¿æ¥æ€»æ•°æ— å…³`ï¼Œå› æ­¤åœ¨å®é™…çš„ç½‘ç»œç¯å¢ƒä¸­ï¼ŒEpollçš„æ•ˆç‡å°±ä¼šè¿œè¿œé«˜äºselectå’Œpollã€‚

`3ã€å†…å­˜æ‹·è´`ï¼Œåˆ©ç”¨mmap()æ–‡ä»¶æ˜ å°„å†…å­˜åŠ é€Ÿä¸å†…æ ¸ç©ºé—´çš„æ¶ˆæ¯ä¼ é€’ï¼›`å³epollä½¿ç”¨mmapå‡å°‘å¤åˆ¶å¼€é”€`ã€‚

æ³¨æ„ï¼šå¦‚æœæ²¡æœ‰å¤§é‡çš„idle-connectionæˆ–è€…dead-connectionï¼Œepollçš„æ•ˆç‡å¹¶ä¸ä¼šæ¯”select/pollé«˜å¾ˆå¤šï¼Œä½†æ˜¯å½“é‡åˆ°å¤§é‡çš„idle-connectionï¼Œå°±ä¼šå‘ç°epollçš„æ•ˆç‡å¤§å¤§é«˜äºselect/pollã€‚

# 6ã€selectã€pollã€epollåŒºåˆ«

## 1ã€æœ€å¤§è¿æ¥æ•°

| select | å•ä¸ªè¿›ç¨‹æ‰€èƒ½æ‰“å¼€çš„æœ€å¤§è¿æ¥æ•°ç”±FD_SETSIZEå®å®šä¹‰ï¼Œå…¶å¤§å°æ˜¯32ä¸ªæ•´æ•°çš„å¤§å°ï¼ˆåœ¨32ä½çš„æœºå™¨ä¸Šï¼Œå¤§å°å°±æ˜¯32x32ï¼ŒåŒç†64ä½æœºå™¨ä¸ŠFD_SETSIZEä¸º32x64ï¼‰ï¼Œå½“ç„¶æˆ‘ä»¬å¯ä»¥å¯¹å…¶è¿›è¡Œä¿®æ”¹ï¼Œç„¶åé‡æ–°ç¼–è¯‘å†…æ ¸ï¼Œä½†æ˜¯æ€§èƒ½å¯èƒ½ä¼šå—åˆ°å½±å“ï¼Œè¿™éœ€è¦è¿›ä¸€æ­¥æµ‹è¯•ã€‚ |
| ------ | ------------------------------------------------------------ |
| poll   | pollæœ¬è´¨ä¸Šå’Œselectæ²¡æœ‰åŒºåˆ«ï¼Œä½†æ˜¯å®ƒæ²¡æœ‰æœ€å¤§è¿æ¥æ•°çš„é™åˆ¶ï¼ŒåŸå› æ˜¯å®ƒæ˜¯åŸºäºé“¾è¡¨æ¥å‚¨å­˜çš„ã€‚ |
| epoll  | è™½ç„¶è¿æ¥æœ‰ä¸Šçº¿ï¼Œä½†æ˜¯å¾ˆå¤§ï¼Œ1Gå†…å­˜çš„æœºå™¨ä¸Šå¯ä»¥æ‰“å¼€10ä¸‡å·¦å³çš„è¿æ¥ï¼Œ2Gå†…å­˜çš„æœºå™¨å¯ä»¥æ‰“å¼€20ä¸‡å·¦å³çš„è¿æ¥ã€‚ |

## 2ã€IOæ•ˆç‡é—®é¢˜

| select | å› ä¸ºæ¯æ¬¡è°ƒç”¨éƒ½ä¼šå¯¹è¿æ¥è¿›è¡Œçº¿æ€§éå†ï¼Œæ‰€ä»¥éšç€FDçš„å¢åŠ ä¼šé€ æˆéå†é€Ÿåº¦æ…¢çš„"çº¿æ€§ä¸‹é™æ€§èƒ½é—®é¢˜"ã€‚ |
| ------ | ------------------------------------------------------------ |
| Poll   | åŒä¸Š                                                         |
| Epoll  | å› ä¸ºepollå†…æ ¸ä¸­å®ç°äº‹æ ¹æ®æ¯ä¸ªfdä¸Šçš„callbackå‡½æ•°æ¥å®ç°çš„ï¼Œåªæœ‰æ´»è·ƒçš„socketæ‰ä¼šä¸»åŠ¨è°ƒç”¨callbackï¼Œæ‰€ä»¥åœ¨æ´»è·ƒsocketè¾ƒå°‘çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨epollæ²¡æœ‰å‰é¢ä¸¤è€…çš„çº¿å½¢ä¸‹é™çš„æ€§èƒ½é—®é¢˜ï¼Œä½†æ˜¯æ‰€æœ‰socketéƒ½å¾ˆæ´»è·ƒçš„æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šæœ‰çº¿æ€§é—®é¢˜ã€‚ |

## 3ã€æ¶ˆæ¯ä¼ é€’æ–¹å¼

| select | å†…æ ¸éœ€è¦å°†æ¶ˆæ¯ä¼ é€’åˆ°ç”¨æˆ·ç©ºé—´ï¼Œéƒ½éœ€è¦å†…æ ¸æ‹·è´åŠ¨ä½œ |
| ------ | ------------------------------------------------ |
| poll   | åŒä¸Š                                             |
| epoll  | epollé€šè¿‡å†…æ ¸å’Œç”¨æˆ·å…±äº«ä¸€å—å†…å­˜æ¥å®ç°çš„          |

ç»¼ä¸Šï¼Œåœ¨é€‰æ‹©selectï¼Œpollï¼Œepollæ—¶è¦æ ¹æ®å…·ä½“çš„ä½¿ç”¨åœºåˆä»¥åŠè¿™ä¸‰ç§æ–¹å¼çš„è‡ªèº«ç‰¹ç‚¹ï¼š

1ã€è¡¨é¢ä¸Šçœ‹epollçš„æ€§èƒ½æœ€å¥½ï¼Œ`ä½†æ˜¯åœ¨è¿æ¥æ•°å°‘å¹¶ä¸”è¿æ¥éƒ½ååˆ†æ´»è·ƒçš„æƒ…å†µä¸‹ï¼Œselectå’Œpollçš„æ€§èƒ½å¯èƒ½æ¯”epollå¥½`ï¼Œæ¯•ç«Ÿepollçš„é€šçŸ¥æœºåˆ¶éœ€è¦å¾ˆå¤šå‡½æ•°å›è°ƒã€‚

`2ã€selectä½æ•ˆæ˜¯å› ä¸ºæ¯æ¬¡å®ƒéƒ½éœ€è¦è½®è¯¢`ã€‚ä½†ä½æ•ˆä¹Ÿæ˜¯ç›¸å¯¹çš„ï¼Œè§†æƒ…å†µè€Œå®šï¼Œä¹Ÿå¯é€šè¿‡è‰¯å¥½çš„è®¾è®¡æ”¹å–„ã€‚

